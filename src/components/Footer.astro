---
import * as fs from "node:fs";
import * as path from "node:path";
import { footerConfig, profileConfig } from "../config";
import { url } from "../utils/url-utils";

const currentYear = new Date().getFullYear();

// 1. 获取页脚自定义 HTML（完全保留你原来的逻辑）
let customFooterHtml = "";
if (footerConfig.enable) {
	if (footerConfig.customHtml && footerConfig.customHtml.trim() !== "") {
		customFooterHtml = footerConfig.customHtml.trim();
	} else {
		try {
			const footerConfigPath = path.join(process.cwd(), "src", "FooterConfig.html");
			customFooterHtml = fs.readFileSync(footerConfigPath, "utf-8");
			customFooterHtml = customFooterHtml.replace(//g, "").trim();
		} catch (error) {
			console.warn("FooterConfig.html 读取失败:", error.message);
		}
	}
}
---

<div class="transition border-t border-black/10 dark:border-white/15 my-10 border-dashed mx-4 md:mx-32"></div>

<div class="card-base w-fit mx-auto rounded-xl mt-4 mb-12">
    <div class="transition text-50 text-sm text-center p-6 leading-relaxed">
        
        {customFooterHtml && (
            <div class="mb-3 pb-3 border-b border-black/5 dark:border-white/5" set:html={customFooterHtml}></div>
        )}

        <div class="mb-2">
            &copy; <span>2024 - {currentYear}</span> 
            <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://Blog.quiyu.cn">{profileConfig.name}</a>
        </div>

        <div class="mb-2 flex items-center justify-center gap-3 text-black/40 dark:text-white/40 font-medium">
            <a class="transition link text-[var(--primary)]" href={url('rss.xml')}>RSS</a>
            <span class="opacity-20">/</span>
            <a class="transition link text-[var(--primary)]" href={url('sitemap-index.xml')}>Sitemap</a>
        </div>

        <div class="text-[11px] text-black/30 dark:text-white/30">
            Powered by 
            <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://astro.build">Astro</a> & 
            <a class="transition link text-[var(--primary)] font-medium" target="_blank" href="https://github.com/qiuyuxc/Mizuki">Mizuki</a>
        </div>

        <div id="cdn-status" class="mt-3 pt-3 border-t border-black/5 dark:border-white/5 text-[10px] text-black/20 dark:text-white/20">
            正在探测访问节点...
        </div>
    </div>
</div>

<script is:inline>
    async function checkNode() {
        const el = document.getElementById('cdn-status');
        if (!el) return;
        try {
            const res = await fetch(window.location.href, { method: 'HEAD' });
            const server = res.headers.get('server') || 'Origin';
            let node = server;
            if (server.toLowerCase().includes('cloudflare')) node = 'Cloudflare';
            if (server.toLowerCase().includes('edgeone') || server.toLowerCase().includes('esa')) node = 'Tencent EdgeOne';
            el.innerHTML = `<span class="inline-block w-1.5 h-1.5 rounded-full bg-green-500/50 mr-1"></span> 访问节点: ${node}`;
        } catch (e) {
            el.remove();
        }
    }
    checkNode();
    document.addEventListener('astro:after-swap', checkNode);
</script>
